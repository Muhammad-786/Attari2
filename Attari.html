<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attari ‚Äî Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      color-scheme: light dark;
      --grad-1: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --grad-2: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
      --grad-emerald: linear-gradient(135deg,#10b981 0%,#059669 100%);
      --glow: 0 0 30px rgba(102,126,234,.35);
      --glow-emerald: 0 0 30px rgba(16,185,129,.35);
    }
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;scroll-behavior:smooth}
    .glass{backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
    .gradient-animated{background:linear-gradient(-45deg,#667eea,#764ba2,#4facfe,#00f2fe);background-size:400% 400%;animation:gradShift 10s ease infinite}
    @keyframes gradShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .float{animation:float 6s ease-in-out infinite}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}
    .btn-primary{background:var(--grad-emerald);position:relative;overflow:hidden;transition:transform .2s ease, box-shadow .2s ease}
    .btn-primary::before{content:"";position:absolute;inset:0;left:-100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.35),transparent);transition:left .5s}
    .btn-primary:hover::before{left:100%}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:var(--glow-emerald)}
    .spinner{width:18px;height:18px;border:2px solid rgba(16,185,129,.35);border-top:2px solid #10b981;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .custom-scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#667eea,#764ba2);border-radius:4px}
    .notification{position:fixed;top:18px;right:18px;padding:12px 16px;border-radius:12px;color:#fff;font-weight:600;z-index:50;transform:translateX(320px);transition:transform .25s ease}
    .notification.show{transform:translateX(0)}
    .notification.success{background:linear-gradient(135deg,#10b981,#059669)}
    .notification.error{background:linear-gradient(135deg,#ef4444,#dc2626)}
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-slate-950 dark:via-slate-900 dark:to-indigo-950 text-slate-900 dark:text-slate-100 min-h-screen overflow-x-hidden">
  <div id="toast" class="notification" role="status" aria-live="polite"></div>
  <div class="max-w-7xl mx-auto p-4 md:p-8 relative">
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="float">
        <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 via-purple-600 to-emerald-600">Attari Class Tracker</h1>
        <div class="w-24 h-1 gradient-animated mx-auto mt-4 rounded-full"></div>
        <p class="mt-4 text-slate-600 dark:text-slate-400">Beautiful, responsive progress tracking for your class.</p>
        <p class="mt-2 text-sm"><span id="authStatus" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 dark:bg-slate-800/70 ring-1 ring-slate-200 dark:ring-slate-700"><span class="w-2 h-2 rounded-full bg-amber-400" id="dot"></span> <span id="whoami">Not signed in</span> ‚Ä¢ <span id="todayDisplay"></span></span></p>
      </div>
    </header>

    <!-- AUTH GATE (styled) -->
    <div id="authGate" class="max-w-xl mx-auto">
      <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
        <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center justify-between">
          <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-emerald-600">Sign in</h2>
          <button id="showSignup" class="text-sm text-emerald-700 hover:underline">Create account</button>
        </div>
        <form id="signinForm" class="p-6 md:p-8 space-y-4">
          <input id="siEmail" type="email" placeholder="Email" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <input id="siPass" type="password" placeholder="Password" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <button class="btn-primary w-full px-5 py-3 rounded-2xl text-white font-semibold">Sign in</button>
          <p id="siMsg" class="text-sm text-slate-500"></p>
        </form>
        <form id="signupForm" class="hidden p-6 md:p-8 space-y-4">
          <div class="text-sm text-slate-500">Create your teacher account.</div>
          <input id="suEmail" type="email" placeholder="Email" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <input id="suPass" type="password" placeholder="Password (min 6)" minlength="6" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required />
          <button class="btn-primary w-full px-5 py-3 rounded-2xl text-white font-semibold">Create account</button>
          <p id="suMsg" class="text-sm text-slate-500"></p>
          <div class="text-sm"><button id="showSignin" type="button" class="text-emerald-700 hover:underline">Back to sign in</button></div>
        </form>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="grid grid-cols-1 xl:grid-cols-5 gap-6">
        <!-- Form Card -->
        <section class="xl:col-span-2">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-teal-600"><span id="formTitle">‚ú® New Entry</span></h2>
                <p id="classStatus" class="text-xs text-slate-500 dark:text-slate-400 mt-1">Select a class to get started.</p>
              </div>
              <button id="signOutBtn" class="px-3 py-1.5 rounded-xl ring-1 ring-slate-300 dark:ring-slate-700 text-sm self-start md:self-auto">Sign out</button>
            </div>
            <div class="px-6 md:px-8 pt-6 border-b border-slate-200/50 dark:border-slate-700/50 space-y-4">
              <div>
                <label class="block text-sm font-semibold mb-2">üè´ Class</label>
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                  <select id="classSelect" class="w-full sm:flex-1 rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 text-sm focus:border-emerald-500 focus:ring-0" aria-label="Select class">
                    <option value="" disabled selected>Loading classes‚Ä¶</option>
                  </select>
                  <div class="flex flex-wrap gap-2">
                    <button id="newClassBtn" type="button" class="px-4 py-2 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white text-sm font-semibold shadow">‚ûï New class</button>
                    <button id="joinClassBtn" type="button" class="px-4 py-2 rounded-2xl bg-slate-200/80 dark:bg-slate-700/80 text-slate-700 dark:text-slate-200 text-sm font-semibold border border-slate-300/40 dark:border-slate-600/40">üîë Join class</button>
                  </div>
                </div>
                <p id="classHint" class="mt-2 text-xs text-slate-500 dark:text-slate-400">Create or join a class to manage its own notes database.</p>
              </div>
              <div>
                <div class="flex items-center justify-between gap-3 mb-2">
                  <span class="block text-sm font-semibold">üë• Students</span>
                  <button id="addStudentBtn" type="button" class="px-3 py-1.5 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-500 text-white text-xs font-semibold shadow">‚ûï Add student</button>
                </div>
                <div id="studentsChips" class="flex flex-wrap gap-2 text-xs text-slate-600 dark:text-slate-400">
                  <span class="px-3 py-1 rounded-full bg-slate-200/60 dark:bg-slate-800/60">No class selected.</span>
                </div>
              </div>
            </div>
            <form id="notesForm" class="p-6 md:p-8 space-y-6">
              <div>
                <label class="block text-sm font-semibold mb-1">üë§ Student</label>
                <select id="student" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-emerald-500 focus:ring-0" required>
                  <option value="" disabled selected>Choose a student‚Ä¶</option>
                </select>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-1">üìñ Quran</label><input id="quran" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-blue-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">üïå Surah</label><input id="surah" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-purple-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">ü§≤ Laws of Salah</label><input id="laws" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-indigo-500 focus:ring-0" /></div>
                <div><label class="block text-sm font-semibold mb-1">üåô Qamar</label><input id="qamar" type="text" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-pink-500 focus:ring-0" /></div>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">üí≠ Additional Notes</label>
                <textarea id="anything" rows="4" class="w-full rounded-2xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-3 focus:border-teal-500 focus:ring-0"></textarea>
              </div>
              <div class="flex flex-col sm:flex-row gap-4">
                <button id="saveBtn" type="submit" class="btn-primary flex-1 px-6 py-4 rounded-2xl text-white font-bold inline-flex items-center justify-center gap-3"><span id="saveText">üíæ Save Entry</span><div id="saveSpinner" class="spinner hidden"></div></button>
                <button id="cancelEditBtn" type="button" class="hidden px-6 py-4 rounded-2xl bg-slate-200/80 dark:bg-slate-700/80 text-slate-700 dark:text-slate-200 font-medium border border-slate-300/40 dark:border-slate-600/40">‚úñÔ∏è Cancel Edit</button>
              </div>
              <div id="saveStatus" class="text-center text-sm font-medium"></div>
            </form>
          </div>
        </section>

        <!-- History Card -->
        <section class="xl:col-span-3">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">üìä Progress History</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400">Real-time per-student notes (latest first)</p>
              </div>
              <div class="flex flex-wrap gap-3">
                <select id="filterStudent" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500">
                  <option value="">All students</option>
                </select>
                <input id="filterDate" type="date" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-blue-500" />
                <button id="clearFilters" class="px-4 py-2 rounded-xl bg-slate-200/80 dark:bg-slate-700/80 text-slate-700 dark:text-slate-200">üîÑ Clear</button>
              </div>
            </div>
            <div class="overflow-hidden">
              <div class="overflow-x-auto custom-scrollbar max-h-[75vh]">
                <table class="min-w-full text-left text-sm">
                  <thead class="sticky top-0 backdrop-blur bg-slate-100/90 dark:bg-slate-800/90">
                    <tr>
                      <th class="px-6 py-3 font-semibold">üìÖ Date</th>
                      <th class="px-6 py-3 font-semibold">üë§ Student</th>
                      <th class="px-6 py-3 font-semibold">üìñ Quran</th>
                      <th class="px-6 py-3 font-semibold">üïå Surah</th>
                      <th class="px-6 py-3 font-semibold">ü§≤ Salah</th>
                      <th class="px-6 py-3 font-semibold">üåô Qamar</th>
                      <th class="px-6 py-3 font-semibold">üí≠ Notes</th>
                      <th class="px-6 py-3 font-semibold">‚ö° Actions</th>
                    </tr>
                  </thead>
                  <tbody id="historyBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              <div id="emptyState" class="hidden text-center py-14">
                <div class="text-6xl mb-3">üìù</div>
                <h3 class="text-lg font-semibold text-slate-600 dark:text-slate-400">No entries yet</h3>
                <p class="text-slate-500">Add your first note using the form.</p>
              </div>
            </div>
            <div class="p-6 flex items-center justify-between border-t border-slate-200/50 dark:border-slate-700/50">
              <div id="countInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
              <button id="reload" class="px-4 py-2 rounded-xl text-white font-medium shadow-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600">üîÑ Refresh</button>
            </div>
          </div>
        </section>

        <!-- Monthly Reports Card -->
        <section class="xl:col-span-5">
          <div class="glass bg-white/70 dark:bg-slate-900/70 rounded-3xl shadow-2xl border border-white/20 dark:border-slate-700/30">
            <div class="p-6 md:p-8 border-b border-slate-200/50 dark:border-slate-700/50 flex flex-col lg:flex-row gap-4 lg:items-center lg:justify-between">
              <div>
                <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-blue-600">üóìÔ∏è Monthly Reports</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400">Review per-student progress and export it as a CSV or PDF file.</p>
              </div>
              <div class="flex flex-wrap gap-3 items-center">
                <select id="reportStudent" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus-border-emerald-500">
                  <option value="" disabled selected>Select a student‚Ä¶</option>
                </select>
                <input id="reportMonth" type="month" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500" />
                <select id="reportFormat" class="rounded-xl bg-slate-50/80 dark:bg-slate-800/80 border-2 border-slate-200/60 dark:border-slate-700/60 px-4 py-2 text-sm font-medium focus:border-emerald-500">
                  <option value="csv" selected>CSV</option>
                  <option value="pdf">PDF</option>
                </select>
                <button id="reportDownload" type="button" class="px-4 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-medium shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>‚¨áÔ∏è Download CSV</button>
              </div>
            </div>
            <div class="p-6 md:p-8 space-y-6">
              <div id="reportInfo" class="text-sm text-slate-600 dark:text-slate-400"></div>
              <div id="reportTableWrapper" class="overflow-x-auto custom-scrollbar hidden">
                <table class="min-w-full text-left text-sm">
                  <thead class="bg-slate-100/80 dark:bg-slate-800/80">
                    <tr>
                      <th class="px-6 py-3 font-semibold">üìÖ Date</th>
                      <th class="px-6 py-3 font-semibold">üìñ Quran</th>
                      <th class="px-6 py-3 font-semibold">üïå Surah</th>
                      <th class="px-6 py-3 font-semibold">ü§≤ Salah</th>
                      <th class="px-6 py-3 font-semibold">üåô Qamar</th>
                      <th class="px-6 py-3 font-semibold">üí≠ Notes</th>
                    </tr>
                  </thead>
                  <tbody id="reportBody" class="divide-y divide-slate-200/50 dark:divide-slate-700/50"></tbody>
                </table>
              </div>
              <div id="reportEmpty" class="text-center text-slate-500 py-10">
                <div class="text-5xl mb-3">üìÇ</div>
                <p id="reportEmptyText">Select a student to see their monthly report.</p>
              </div>
            </div>
          </div>
        </section>
      </div>

      <footer class="mt-12 text-center">
        <div class="glass bg-white/60 dark:bg-slate-800/60 rounded-2xl px-6 py-4 inline-block">
          <p class="text-xs text-slate-600 dark:text-slate-400">üîí Data: <span id="classPathLabel" class="font-mono font-semibold">classes/‚Äî/notes</span> ‚Ä¢ Unique per <em>date + student</em></p>
        </div>
      </footer>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, query, orderBy, where, limit as qLimit, onSnapshot, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyCTGIoNNey_0GwRxg_85Xv-jEQtQDjzehw", authDomain:"attari-579d2.firebaseapp.com", projectId:"attari-579d2", storageBucket:"attari-579d2.firebasestorage.app", messagingSenderId:"765966619098", appId:"1:765966619098:web:9ab852c4881426472b70e3" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authGate = document.getElementById('authGate');
    const appShell = document.getElementById('app');
    const authStatus = document.getElementById('authStatus');
    const dot = document.getElementById('dot');
    const whoami = document.getElementById('whoami');
    const signOutBtn = document.getElementById('signOutBtn');
    const toast = document.getElementById('toast');

    // Forms
    const signinForm = document.getElementById('signinForm');
    const signupForm = document.getElementById('signupForm');
    document.getElementById('showSignup').addEventListener('click',()=>{signinForm.classList.add('hidden');signupForm.classList.remove('hidden')});
    document.getElementById('showSignin').addEventListener('click',()=>{signupForm.classList.add('hidden');signinForm.classList.remove('hidden')});

    signinForm.addEventListener('submit', async (e)=>{e.preventDefault();const email=siEmail.value.trim();const pass=siPass.value;siMsg.textContent='';try{await signInWithEmailAndPassword(auth,email,pass);}catch(err){siMsg.textContent=err.message;showToast(err.message,'error')}});
    signupForm.addEventListener('submit', async (e)=>{e.preventDefault();const email=suEmail.value.trim();const pass=suPass.value;suMsg.textContent='';try{await createUserWithEmailAndPassword(auth,email,pass);suMsg.textContent='Account created. Signed in.';showToast('Welcome!','success')}catch(err){suMsg.textContent=err.message;showToast(err.message,'error')}});
    signOutBtn?.addEventListener('click', ()=>signOut(auth));

    // Students and elements
    const MONTH_LABELS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const classSelect=document.getElementById('classSelect');
    const newClassBtn=document.getElementById('newClassBtn');
    const joinClassBtn=document.getElementById('joinClassBtn');
    const addStudentBtn=document.getElementById('addStudentBtn');
    const studentsChips=document.getElementById('studentsChips');
    const classHint=document.getElementById('classHint');
    const classStatus=document.getElementById('classStatus');
    const classPathLabel=document.getElementById('classPathLabel');
    const inputs={student:document.getElementById('student'),quran:document.getElementById('quran'),surah:document.getElementById('surah'),laws:document.getElementById('laws'),qamar:document.getElementById('qamar'),anything:document.getElementById('anything')};
    const notesForm=document.getElementById('notesForm');
    const filterStudent=document.getElementById('filterStudent');
    const filterDate=document.getElementById('filterDate');
    const historyBody=document.getElementById('historyBody');
    const emptyState=document.getElementById('emptyState');
    const countInfo=document.getElementById('countInfo');
    const formTitle=document.getElementById('formTitle');
    const cancelEditBtn=document.getElementById('cancelEditBtn');
    const saveBtn=document.getElementById('saveBtn');
    const saveText=document.getElementById('saveText');
    const saveSpinner=document.getElementById('saveSpinner');
    const saveStatus=document.getElementById('saveStatus');
    const reportStudent=document.getElementById('reportStudent');
    const reportMonth=document.getElementById('reportMonth');
    const reportFormat=document.getElementById('reportFormat');
    const reportBody=document.getElementById('reportBody');
    const reportTableWrapper=document.getElementById('reportTableWrapper');
    const reportEmpty=document.getElementById('reportEmpty');
    const reportEmptyText=document.getElementById('reportEmptyText');
    const reportInfo=document.getElementById('reportInfo');
    const reportDownload=document.getElementById('reportDownload');

    // Populate selects
    let classStudents=[];
    let pendingStudentSelection=null;
    function populateStudents(list){
      const prevStudent=inputs.student.value;
      const prevFilterStudent=filterStudent.value;
      const prevReportStudent=reportStudent.value;
      const cleaned=Array.isArray(list)?Array.from(new Set(list.map(s=>s?.toString().trim()).filter(Boolean))):[];
      const sorted=cleaned.sort((a,b)=>a.localeCompare(b,'en',{sensitivity:'base'}));
      classStudents=sorted;

      inputs.student.innerHTML='<option value="" disabled selected>Choose a student‚Ä¶</option>';
      sorted.forEach(name=>{
        const option=document.createElement('option');
        option.value=name;
        option.textContent=name;
        inputs.student.appendChild(option);
      });

      filterStudent.innerHTML='<option value="">All students</option>';
      sorted.forEach(name=>{
        const option=document.createElement('option');
        option.value=name;
        option.textContent=name;
        filterStudent.appendChild(option);
      });

      reportStudent.innerHTML='<option value="" disabled selected>Select a student‚Ä¶</option>';
      sorted.forEach(name=>{
        const option=document.createElement('option');
        option.value=name;
        option.textContent=name;
        reportStudent.appendChild(option);
      });

      if(pendingStudentSelection&&sorted.includes(pendingStudentSelection)){
        inputs.student.value=pendingStudentSelection;
      }else if(prevStudent&&sorted.includes(prevStudent)){
        inputs.student.value=prevStudent;
      }

      filterStudent.value=prevFilterStudent&&sorted.includes(prevFilterStudent)?prevFilterStudent:'';
      reportStudent.value=prevReportStudent&&sorted.includes(prevReportStudent)?prevReportStudent:'';
      pendingStudentSelection=null;

      const classActive=Boolean(currentClassId);
      inputs.student.disabled=!classActive||!sorted.length;
      filterStudent.disabled=!classActive||!sorted.length;
      reportStudent.disabled=!classActive||!sorted.length;
      addStudentBtn.disabled=!classActive;

      if(studentsChips){
        if(sorted.length){
          studentsChips.innerHTML=sorted.map(name=>`<span class="px-3 py-1 rounded-full bg-slate-200/70 dark:bg-slate-800/70">${esc(name)}</span>`).join('');
        }else{
          const emptyLabel=classActive?'No students yet.':'No class selected.';
          studentsChips.innerHTML=`<span class="px-3 py-1 rounded-full bg-slate-200/60 dark:bg-slate-800/60">${esc(emptyLabel)}</span>`;
        }
      }

      const selectedStudent=inputs.student.value;
      if(classActive&&selectedStudent&&selectedStudent!==prevStudent){
        maybeLoadTodaysEntry(selectedStudent);
      }
    }

    function setFormDisabled(disabled){
      if(disabled){
        notesForm.classList.add('opacity-60');
      }else{
        notesForm.classList.remove('opacity-60');
      }
      const elements=notesForm.querySelectorAll('input, textarea, select, button');
      elements.forEach(el=>{
        if(el.id==='cancelEditBtn')return;
        if(el===inputs.student){
          el.disabled=disabled||!classStudents.length;
          return;
        }
        if(el.id==='saveBtn'){
          el.disabled=disabled;
          el.classList.toggle('opacity-60',disabled);
          el.classList.toggle('cursor-not-allowed',disabled);
        }else{
          el.disabled=disabled;
        }
      });
      filterStudent.disabled=disabled||!classStudents.length;
      filterDate.disabled=disabled;
      reportStudent.disabled=disabled||!classStudents.length;
      reportMonth.disabled=disabled;
      reportFormat.disabled=disabled;
      reportDownload.disabled=true;
      addStudentBtn.disabled=disabled||!currentClassId;
    }

    function updateClassPathLabelText(classId){
      if(classPathLabel)classPathLabel.textContent=classId?`classes/${classId}/notes`:'classes/‚Äî/notes';
    }

    function updateClassHint(classId,className=''){
      if(!classHint)return;
      if(classId){
        const nameHtml=className?`<span class="font-semibold">${esc(className)}</span> ‚Ä¢ `:'';
        const rulesHtml=`<span class="block text-[0.7rem] text-slate-500 dark:text-slate-400 mt-1">Firestore rule: <span class="font-mono">match /classes/{classId}/notes/{noteId}</span></span>`;
        classHint.innerHTML=`${nameHtml}Class code: <span class="font-mono font-semibold">${esc(classId)}</span> ‚Ä¢ Data path <span class="font-mono">classes/${esc(classId)}/notes</span>${rulesHtml}`;
      }else{
        classHint.innerHTML='Create or join a class to manage its own notes database.<span class="block text-[0.7rem] text-slate-500 dark:text-slate-400 mt-1">Firestore rule: <span class="font-mono">match /classes/{classId}/notes/{noteId}</span></span>';
      }
    }

    function updateClassStatus(text){
      if(classStatus)classStatus.textContent=text;
    }

    const now=new Date();
    const todayKey=toLocalISODate(now);
    document.getElementById('todayDisplay').textContent=formatDisplayDate(todayKey);
    if(reportMonth)reportMonth.value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;

    const slug=s=>s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const noteId=(date,student)=>`${date}_${slug(student)}`;

    // Edit mode
    let editingKey=null;
    function setEditMode(n=null,{preserveStudent=false}={}){
      const previousStudent=inputs.student.value;
      if(n){
        editingKey=n.id;
        formTitle.textContent='‚úèÔ∏è Edit Entry';
        saveText.textContent='‚úÖ Update Entry';
        cancelEditBtn.classList.remove('hidden');
        if(n.student){
          if(!classStudents.includes(n.student)){
            pendingStudentSelection=n.student;
            populateStudents(classStudents);
          }
          inputs.student.value=n.student;
        }
        inputs.quran.value=n.quran||'';
        inputs.surah.value=n.surah||'';
        inputs.laws.value=n.lawsOfSalah||'';
        inputs.qamar.value=n.qamar||'';
        inputs.anything.value=n.anythingElse||n.other||'';
      } else {
        editingKey=null;
        formTitle.textContent='‚ú® New Entry';
        saveText.textContent='üíæ Save Entry';
        cancelEditBtn.classList.add('hidden');
        notesForm.reset();
        if(preserveStudent&&previousStudent){
          inputs.student.value=previousStudent;
        }
      }
    }
    cancelEditBtn.addEventListener('click',()=>setEditMode(null,{preserveStudent:true}));

    // Save/Update
    notesForm.addEventListener('submit',async(e)=>{
      e.preventDefault();
      const notesRef=getClassNotesCollection();
      if(!currentClassId||!notesRef){
        saveStatus.textContent='Select a class first';
        showToast('Select a class before saving.','error');
        return;
      }
      const student=inputs.student.value;
      if(!student){saveStatus.textContent='Choose a student';return;}
      saveSpinner.classList.remove('hidden');
      saveBtn.disabled=true;
      try{
        const defaultDate=toLocalISODate(new Date());
        const entryDate=editingKey?extractDateFromId(editingKey)||defaultDate:defaultDate;
        const id=editingKey||noteId(entryDate,student);
        const ref=doc(notesRef,id);
        const payload={
          id,
          date:entryDate,
          student,
          quran:inputs.quran.value.trim(),
          surah:inputs.surah.value.trim(),
          lawsOfSalah:inputs.laws.value.trim(),
          qamar:inputs.qamar.value.trim(),
          anythingElse:inputs.anything.value.trim(),
          updatedAt:serverTimestamp(),
          ownerUid:auth.currentUser?.uid||null
        };
        const snap=await getDoc(ref);
        if(!snap.exists())payload.createdAt=serverTimestamp();
        await setDoc(ref,payload,{merge:true});
        showToast(editingKey?'Updated ‚úì':'Saved ‚úì','success');
        saveStatus.textContent=editingKey?'Updated ‚úÖ':'Saved ‚úÖ';
        setTimeout(()=>saveStatus.textContent='',1200);
        setEditMode(null,{preserveStudent:true});
      }catch(err){
        console.error(err);
        saveStatus.textContent='Failed to save ‚ùå';
        showToast('Failed to save note.','error');
      }finally{
        saveSpinner.classList.add('hidden');
        saveBtn.disabled=false;
      }
    });

    // History stream & filters
    let currentUser=null;
    let currentClassId=null;
    let currentClassName='';
    let classesUnsub=null;
    let classDocUnsub=null;
    let unsub=null;
    let historyRows=[];
    let currentReportRows=[];
    let reportRequestToken=0;
    let jsPdfModulePromise=null;
    let userClasses=[];
    const legacyNotesRef=collection(db,'classes','Attari','notes');
    let legacyNotesCache=[];
    let legacyNotesPromise=null;
    let legacyNotesClassId=null;
    let lastClassRows=[];
    let historySnapshotToken=0;

    function getClassDocRef(classId=currentClassId){
      return classId?doc(db,'classes',classId):null;
    }

    function getClassNotesCollection(classId=currentClassId){
      const classRef=getClassDocRef(classId);
      return classRef?collection(classRef,'notes'):null;
    }

    function startHistoryStream(){
      if(unsub)unsub();
      historyRows=[];
      lastClassRows=[];
      renderHistory([]);

      const notesRef=getClassNotesCollection();
      if(!notesRef)return;
      const q=query(notesRef,orderBy('date','desc'),qLimit(200));
      unsub=onSnapshot(q,(snap)=>{
        historyRows=snap.docs.map(d=>({id:d.id,...d.data()}));

        applyFilters();
        try{
          const legacyRows=await ensureLegacyNotesLoaded();
          if(token!==historySnapshotToken)return;
          historyRows=mergeNoteRows(baseRows,legacyRows,'desc');
          applyFilters();
        }catch(err){
          if(token===historySnapshotToken)console.error('Failed to include legacy notes',err);
        }
      });
    }

    function resetLegacyCache(){
      legacyNotesCache=[];
      legacyNotesPromise=null;
      legacyNotesClassId=null;
    }

    async function ensureLegacyNotesLoaded(){
      if(!currentUser||!currentClassId)return [];
      if(legacyNotesPromise&&legacyNotesClassId===currentClassId){
        const cached=await legacyNotesPromise;
        return cached.slice();
      }
      const targetClassId=currentClassId;
      const ownerUid=currentUser.uid;
      legacyNotesClassId=targetClassId;
      legacyNotesPromise=(async()=>{
        const rows=await fetchLegacyNotesForClass(ownerUid,targetClassId);
        if(legacyNotesClassId===targetClassId){
          legacyNotesCache=rows;
          return rows;
        }
        return [];
      })();
      try{
        const rows=await legacyNotesPromise;
        if(legacyNotesClassId!==targetClassId)return [];
        return rows.slice();
      }catch(err){
        if(legacyNotesClassId===targetClassId){
          resetLegacyCache();
        }
        throw err;
      }
    }

    async function fetchLegacyNotesForClass(ownerUid,targetClassId){
      if(!ownerUid||!targetClassId)return [];
      try{
        const legacyQuery=query(legacyNotesRef,where('ownerUid','==',ownerUid));
        const snap=await getDocs(legacyQuery);
        const rows=[];
        const migrations=[];
        snap.forEach(docSnap=>{
          const data=docSnap.data()||{};
          if(data.classId)return;
          const row={id:docSnap.id,__docPath:docSnap.ref.path,__source:'legacy',...data,classId:data.classId||targetClassId};
          rows.push(row);
          migrations.push(updateDoc(docSnap.ref,{classId:targetClassId}).catch(err=>{
            console.error('Failed to migrate legacy note',err);
          }));
        });
        if(migrations.length){
          await Promise.allSettled(migrations);
        }
        return rows;
      }catch(err){
        console.error('Failed to load legacy notes',err);
        return [];
      }
    }

    function mergeNoteRows(primaryRows=[],secondaryRows=[],direction='desc'){
      const map=new Map();
      (secondaryRows||[]).forEach(row=>{
        if(row&&row.id)map.set(row.id,row);
      });
      (primaryRows||[]).forEach(row=>{
        if(row&&row.id)map.set(row.id,row);
      });
      const merged=Array.from(map.values());
      merged.sort((a,b)=>compareNoteRows(a,b,direction));
      return merged;
    }

    function compareNoteRows(a,b,direction='desc'){
      const da=parseDate(a?.date);
      const db=parseDate(b?.date);
      if(da&&db&&da.getTime()!==db.getTime()){
        return direction==='desc'?db.getTime()-da.getTime():da.getTime()-db.getTime();
      }
      if(da&&!db)return direction==='desc'?-1:1;
      if(!da&&db)return direction==='desc'?1:-1;
      const ca=parseDate(a?.createdAt);
      const cb=parseDate(b?.createdAt);
      if(ca&&cb&&ca.getTime()!==cb.getTime()){
        return direction==='desc'?cb.getTime()-ca.getTime():ca.getTime()-cb.getTime();
      }
      if(ca&&!cb)return direction==='desc'?-1:1;
      if(!ca&&cb)return direction==='desc'?1:-1;
      const idA=String(a?.id||'');
      const idB=String(b?.id||'');
      return direction==='desc'?idB.localeCompare(idA):idA.localeCompare(idB);
    }

    function docFromPath(path){
      if(!path)return null;
      const segments=String(path).split('/').filter(Boolean);
      if(!segments.length)return null;
      return doc(db,...segments);
    }

    function applyFilters(){
      if(!getClassNotesCollection()){
        renderHistory([]);
        return;
      }
      const s=filterStudent.value;
      const d=filterDate.value;
      let list=historyRows;
      if(s)list=list.filter(r=>r.student===s);
      if(d)list=list.filter(r=>r.date===d);
      renderHistory(list);
      renderMonthlyReport();
    }
    filterStudent.addEventListener('change',applyFilters);
    filterDate.addEventListener('change',applyFilters);
    document.getElementById('clearFilters').addEventListener('click',()=>{filterStudent.value='';filterDate.value='';applyFilters();});
    document.getElementById('reload').addEventListener('click',applyFilters);

    async function fetchMonthlyRows(student,range){
      const notesRef=getClassNotesCollection();
      if(!notesRef)return [];
      const baseConstraints=[where('date','>=',range.start),where('date','<=',range.end),orderBy('date','asc')];
      const mapSnap=snap=>snap.docs.map(docSnap=>({id:docSnap.id,__docPath:docSnap.ref.path,__source:'class',...docSnap.data()}));
      let classRows=[];
      if(!student){

        const snap=await getDocs(query(notesRef,...baseConstraints));
        return mapSnap(snap);

      }
      let legacyRows=[];
      try{

        const snap=await getDocs(query(notesRef,where('student','==',student),...baseConstraints));
        return mapSnap(snap);
      }catch(err){
        // fallback if composite index is missing
        if(err?.code==='failed-precondition'||/index/i.test(err?.message||'')){
          const snap=await getDocs(query(notesRef,...baseConstraints));
          return mapSnap(snap).filter(r=>r.student===student);
        }
        throw err;

      }
      return mergeNoteRows(classRows,legacyRows,'asc');
    }

    reportStudent?.addEventListener('change',renderMonthlyReport);
    reportMonth?.addEventListener('change',renderMonthlyReport);
    reportFormat?.addEventListener('change',updateReportDownloadLabel);
    reportDownload?.addEventListener('click',async()=>{
      if(reportDownload.disabled)return;
      await downloadMonthlyReport();
    });
    renderMonthlyReport();
    updateReportDownloadLabel();
    populateStudents([]);
    setFormDisabled(true);
    updateClassHint(null);
    updateClassStatus('Select a class to get started.');
    updateClassPathLabelText(null);
    renderClassSelect(null);

    classSelect?.addEventListener('change',()=>{
      const value=classSelect.value;
      if(value){
        setCurrentClass(value);
      }
    });
    newClassBtn?.addEventListener('click',handleCreateClass);
    joinClassBtn?.addEventListener('click',handleJoinClass);
    addStudentBtn?.addEventListener('click',handleAddStudent);
    inputs.student.addEventListener('change',()=>maybeLoadTodaysEntry(inputs.student.value));

    function renderHistory(rows){
      historyBody.innerHTML='';
      if(!rows.length){
        emptyState.classList.remove('hidden');
        countInfo.textContent='0 notes';
        return;
      }
      emptyState.classList.add('hidden');
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        const docPath=r.__docPath||(currentClassId?`classes/${currentClassId}/notes/${r.id}`:'');
        const source=r.__source||'class';
        tr.innerHTML=`
          <td class='px-6 py-3 font-medium'>${esc(formatDisplayDate(r.date))}</td>
          <td class='px-6 py-3'>${esc(r.student||'')}</td>
          <td class='px-6 py-3'>${esc(r.quran||'')}</td>
          <td class='px-6 py-3'>${esc(r.surah||'')}</td>
          <td class='px-6 py-3'>${esc(r.lawsOfSalah||'')}</td>
          <td class='px-6 py-3'>${esc(r.qamar||'')}</td>
          <td class='px-6 py-3'>${esc(r.anythingElse||'')}</td>
          <td class='px-6 py-3 whitespace-nowrap'>
            <button class='px-2 py-1 text-xs rounded-lg ring-1 ring-slate-300 mr-2 hover:bg-slate-100 dark:hover:bg-slate-800' data-action='edit' data-id='${esc(r.id)}' data-path='${esc(docPath)}' data-source='${esc(source)}'>Edit</button>
            <button class='px-2 py-1 text-xs rounded-lg ring-1 ring-red-300 text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20' data-action='delete' data-id='${esc(r.id)}' data-path='${esc(docPath)}' data-source='${esc(source)}'>Delete</button>
          </td>`;
        historyBody.appendChild(tr);
      });
      countInfo.textContent=`${rows.length} note${rows.length===1?'':'s'} shown`;
    }

    async function renderMonthlyReport(){
      if(!reportStudent||!reportMonth)return;
      const student=reportStudent.value;
      const monthValue=reportMonth.value;

      currentReportRows=[];
      reportBody.innerHTML='';
      reportInfo.textContent='';

      if(reportDownload){
        reportDownload.disabled=true;
        updateReportDownloadLabel();
      }
      reportTableWrapper.classList.add('hidden');
      reportEmpty.classList.remove('hidden');

      if(!getClassNotesCollection()){
        reportEmptyText.textContent='Select a class to see monthly reports.';
        return;
      }

      if(!student){reportEmptyText.textContent='Select a student to see their monthly report.';return;}
      if(!monthValue){reportEmptyText.textContent='Choose a month to view the report.';return;}

      const requestId=++reportRequestToken;
      reportEmptyText.textContent='Loading report‚Ä¶';

      try{
        const range=getMonthDateRange(monthValue);
        if(!range){reportEmptyText.textContent='Choose a valid month to view the report.';return;}

        const rows=await fetchMonthlyRows(student,range);
        if(requestId!==reportRequestToken)return;

        const filtered=rows.filter(r=>r.student===student&&isInMonth(r.date,monthValue));
        if(!filtered.length){
          if(requestId===reportRequestToken){reportEmptyText.textContent=`No entries found for ${student} in ${formatMonthYear(monthValue)}.`;}
          return;
        }

        const sorted=filtered.slice().sort((a,b)=>{
          const da=parseDate(a.date);const db=parseDate(b.date);
          if(da&&db)return da-db;
          return (a.date||'').localeCompare(b.date||'');
        });
        if(requestId!==reportRequestToken)return;

        reportBody.innerHTML=sorted.map(r=>`
          <tr>
            <td class='px-6 py-3 font-medium'>${esc(formatDisplayDate(r.date))}</td>
            <td class='px-6 py-3'>${esc(r.quran||'')}</td>
            <td class='px-6 py-3'>${esc(r.surah||'')}</td>
            <td class='px-6 py-3'>${esc(r.lawsOfSalah||'')}</td>
            <td class='px-6 py-3'>${esc(r.qamar||'')}</td>
            <td class='px-6 py-3'>${esc(r.anythingElse||'')}</td>
          </tr>`).join('');

        reportTableWrapper.classList.remove('hidden');
        reportEmpty.classList.add('hidden');
        reportInfo.textContent=`${sorted.length} entr${sorted.length===1?'y':'ies'} for ${student} in ${formatMonthYear(monthValue)}.`;
        if(reportDownload){
          reportDownload.disabled=false;
          updateReportDownloadLabel();
        }
        currentReportRows=sorted;
      }catch(err){
        if(requestId!==reportRequestToken)return;
        console.error(err);
        reportEmptyText.textContent='Unable to load monthly report.';
        showToast('Failed to load monthly report','error');
      }
    }

    async function downloadMonthlyReport(){
      if(!getClassNotesCollection()||!currentReportRows.length||!reportStudent||!reportMonth||!reportDownload)return;
      const student=reportStudent.value;
      const monthValue=reportMonth.value;
      if(!student||!monthValue)return;
      const format=(reportFormat?.value||'csv').toLowerCase();

      reportDownload.dataset.loading='true';
      reportDownload.disabled=true;
      updateReportDownloadLabel();

      try{
        if(format==='pdf'){
          await downloadMonthlyPdf(student,monthValue);
        }else{
          downloadMonthlyCsv(student,monthValue);
        }
      }catch(err){
        console.error(err);
        showToast('Download failed','error');
      }finally{
        if(reportDownload.dataset.loading)delete reportDownload.dataset.loading;
        reportDownload.disabled=!currentReportRows.length;
        updateReportDownloadLabel();
      }
    }

    function downloadMonthlyCsv(student,monthValue){
      const rows=[['Date','Student','Quran','Surah','Laws of Salah','Qamar','Notes']];
      currentReportRows.forEach(r=>{
        rows.push([formatDisplayDate(r.date),r.student||'',r.quran||'',r.surah||'',r.lawsOfSalah||'',r.qamar||'',r.anythingElse||'']);
      });
      const csv=rows.map(row=>row.map(toCsvValue).join(',')).join('\r\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const link=document.createElement('a');
      link.href=url;
      link.download=buildReportFilename(student,monthValue,'csv');
      document.body.appendChild(link);
      link.click();
      setTimeout(()=>{URL.revokeObjectURL(url);link.remove();},0);
      showToast('CSV report downloaded ‚úì','success');
    }

    async function downloadMonthlyPdf(student,monthValue){
      const module=await ensureJsPdf();
      const jsPdfConstructor=module?.jsPDF||module?.default?.jsPDF||module?.default;
      if(typeof jsPdfConstructor!=='function')throw new Error('PDF library failed to load');

      const doc=new jsPdfConstructor({orientation:'portrait',unit:'pt'});
      const margin=40;
      const pageHeight=doc.internal.pageSize.getHeight();
      const maxWidth=doc.internal.pageSize.getWidth()-margin*2;

      const monthLabel=formatMonthYear(monthValue)||monthValue;
      let y=margin;

      doc.setFont('helvetica','bold');
      doc.setFontSize(18);
      doc.text('Monthly Report',margin,y);
      y+=24;

      doc.setFont('helvetica','normal');
      doc.setFontSize(12);
      doc.text(`Student: ${student}`,margin,y); y+=16;
      doc.text(`Month: ${monthLabel}`,margin,y); y+=24;

      const lineHeight=14;
      currentReportRows.forEach((row,index)=>{
        if(y>pageHeight-margin){doc.addPage();y=margin;}
        doc.setFont('helvetica','bold');
        doc.text(`${index+1}. ${formatDisplayDate(row.date)}`,margin,y);
        y+=lineHeight;

        doc.setFont('helvetica','normal');
        const sections=[
          ['Quran',row.quran],
          ['Surah',row.surah],
          ['Laws of Salah',row.lawsOfSalah],
          ['Qamar',row.qamar],
          ['Notes',row.anythingElse],
        ];
        sections.forEach(([label,value])=>{
          const text=`‚Ä¢ ${label}: ${value||'-'}`;
          const lines=doc.splitTextToSize(text,Math.max(maxWidth-20,0));
          lines.forEach(line=>{
            if(y>pageHeight-margin){doc.addPage();y=margin;}
            doc.text(line,margin+20,y);
            y+=lineHeight;
          });
        });
        y+=lineHeight/2;
      });

      doc.save(buildReportFilename(student,monthValue,'pdf'));
      showToast('PDF report downloaded ‚úì','success');
    }

    function updateReportDownloadLabel(){
      if(!reportDownload)return;
      if(reportDownload.dataset.loading){reportDownload.textContent='Preparing‚Ä¶';return;}
      const format=(reportFormat?.value||'csv').toUpperCase();
      reportDownload.textContent=`‚¨áÔ∏è Download ${format}`;
    }

    function buildReportFilename(student,monthValue,extension){
      const safeStudent=slug(student||'student')||'student';
      const safeMonth=monthValue||'report';
      return `${safeStudent}-${safeMonth}-report.${extension}`;
    }

    function ensureJsPdf(){
      if(window.jspdf?.jsPDF)return Promise.resolve(window.jspdf);
      if(!jsPdfModulePromise){
        jsPdfModulePromise=new Promise((resolve,reject)=>{
          let script=null;
          const cleanup=()=>{script?.removeEventListener('error',onError);script?.removeEventListener('load',onLoad);};
          const onLoad=()=>{
            cleanup();
            if(window.jspdf?.jsPDF){
              resolve(window.jspdf);
            }else{
              script?.remove();
              jsPdfModulePromise=null;
              reject(new Error('PDF library failed to load'));
            }
          };
          const onError=()=>{
            cleanup();
            script?.remove();
            jsPdfModulePromise=null;
            reject(new Error('Failed to load PDF library'));
          };
          const existing=document.querySelector('script[data-jspdf-loader]');
          if(existing){
            script=existing;
            existing.addEventListener('load',onLoad,{once:true});
            existing.addEventListener('error',onError,{once:true});
            return;
          }
          script=document.createElement('script');
          script.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
          script.async=true;
          script.crossOrigin='anonymous';
          script.dataset.jspdfLoader='true';
          script.addEventListener('load',onLoad,{once:true});
          script.addEventListener('error',onError,{once:true});
          document.head.appendChild(script);
        });
        jsPdfModulePromise=jsPdfModulePromise.catch(err=>{jsPdfModulePromise=null;throw err;});
      }
      return jsPdfModulePromise;
    }

    function renderClassSelect(selectedId){
      if(!classSelect)return;
      classSelect.innerHTML='';
      if(!currentUser){
        const option=document.createElement('option');
        option.value='';
        option.textContent='Sign in to load classes‚Ä¶';
        option.disabled=true;
        option.selected=true;
        classSelect.appendChild(option);
        classSelect.disabled=true;
        return;
      }
      if(!userClasses.length){
        const option=document.createElement('option');
        option.value='';
        option.textContent='No classes yet';
        option.disabled=true;
        option.selected=true;
        classSelect.appendChild(option);
        classSelect.disabled=true;
        return;
      }
      const placeholder=document.createElement('option');
      placeholder.value='';
      placeholder.textContent='Select a class‚Ä¶';
      placeholder.disabled=true;
      classSelect.appendChild(placeholder);
      userClasses.forEach(cls=>{
        const option=document.createElement('option');
        option.value=cls.id;
        option.textContent=cls.name||cls.id;
        classSelect.appendChild(option);
      });
      classSelect.disabled=false;
      if(selectedId&&userClasses.some(c=>c.id===selectedId)){
        classSelect.value=selectedId;
      }else if(currentClassId&&userClasses.some(c=>c.id===currentClassId)){
        classSelect.value=currentClassId;
      }else if(userClasses.length){
        classSelect.value=userClasses[0].id;
      }else{
        placeholder.selected=true;
      }
    }

    function watchUserClasses(uid){
      if(classesUnsub){classesUnsub();classesUnsub=null;}
      userClasses=[];
      renderClassSelect(null);
      if(!uid){
        setCurrentClass(null);
        return;
      }
      const classesRef=collection(db,'classes');
      const classesQuery=query(classesRef,where('members','array-contains',uid));
      classesUnsub=onSnapshot(classesQuery,(snap)=>{
        userClasses=snap.docs.map(docSnap=>({id:docSnap.id,...docSnap.data()})).sort((a,b)=>{
          const nameA=(a.name||a.id||'').toLowerCase();
          const nameB=(b.name||b.id||'').toLowerCase();
          return nameA.localeCompare(nameB);
        });
        const availableIds=userClasses.map(c=>c.id);
        let desired=null;
        if(currentClassId&&availableIds.includes(currentClassId)){
          desired=currentClassId;
        }else if(availableIds.length){
          desired=availableIds[0];
        }
        renderClassSelect(desired);
        if(desired!==currentClassId){
          setCurrentClass(desired||null);
        }else if(!desired){
          setCurrentClass(null);
        }
      },(err)=>{
        console.error('Failed to load classes',err);
        showToast('Unable to load classes','error');
      });
    }

    function resetAppState(){
      if(unsub){unsub();unsub=null;}
      if(classDocUnsub){classDocUnsub();classDocUnsub=null;}
      currentClassId=null;
      currentClassName='';
      userClasses=[];
      historyRows=[];
      currentReportRows=[];
      resetLegacyCache();
      lastClassRows=[];
      historySnapshotToken=0;
      reportInfo.textContent='';
      renderHistory([]);
      reportTableWrapper.classList.add('hidden');
      reportEmpty.classList.remove('hidden');
      reportEmptyText.textContent='Select a class to see monthly reports.';
      filterStudent.value='';
      filterDate.value='';
      if(reportStudent)reportStudent.value='';
      pendingStudentSelection=null;
      setEditMode(null);
      populateStudents([]);
      setFormDisabled(true);
      updateClassPathLabelText(null);
      updateClassHint(null);
      updateClassStatus('Select a class to get started.');
      updateReportDownloadLabel();
    }

    function setCurrentClass(classId){
      if(classId===currentClassId)return;
      if(unsub){unsub();unsub=null;}
      if(classDocUnsub){classDocUnsub();classDocUnsub=null;}
      resetLegacyCache();
      lastClassRows=[];
      historySnapshotToken=0;
      currentClassId=classId||null;
      currentClassName='';
      historyRows=[];
      currentReportRows=[];
      reportInfo.textContent='';
      renderHistory([]);
      saveStatus.textContent='';
      filterStudent.value='';
      filterDate.value='';
      if(reportStudent)reportStudent.value='';
      pendingStudentSelection=null;
      updateClassPathLabelText(currentClassId);
      updateClassHint(currentClassId);
      if(!currentClassId){
        setEditMode(null);
        populateStudents([]);
        setFormDisabled(true);
        updateClassStatus(userClasses.length?'Select a class to get started.':'No classes yet ‚Äî create or join one.');
        reportEmptyText.textContent='Select a class to see monthly reports.';
        return;
      }
      if(classSelect&&classSelect.value!==currentClassId){
        classSelect.value=currentClassId;
      }
      const classRef=getClassDocRef(currentClassId);
      setEditMode(null);
      setFormDisabled(false);
      updateClassStatus('Loading class‚Ä¶');
      classDocUnsub=onSnapshot(classRef,(snap)=>{
        if(!snap.exists()){
          updateClassStatus('Class not found.');
          populateStudents([]);
          setFormDisabled(true);
          if(classHint)classHint.textContent='This class does not exist yet. Create it to get started.';
          return;
        }
        const data=snap.data();
        currentClassName=data.name||currentClassId;
        updateClassStatus(`Working in ${currentClassName}`);
        updateClassHint(currentClassId,currentClassName);
        populateStudents(data.students||[]);
      },(err)=>{
        console.error('Failed to load class',err);
        showToast('Unable to load class','error');
      });
      reportEmptyText.textContent='Select a student to see their monthly report.';
      startHistoryStream();
      applyFilters();
      renderMonthlyReport();
    }

    async function handleCreateClass(){
      if(!currentUser){showToast('Sign in to create a class.','error');return;}
      const name=prompt('Name for the new class?');
      if(name===null)return;
      const trimmed=name.trim();
      if(!trimmed){showToast('Class name is required.','error');return;}
      const id=slug(trimmed);
      if(!id){showToast('Class name must include letters or numbers.','error');return;}
      const classRef=doc(db,'classes',id);
      try{
        const snap=await getDoc(classRef);
        if(snap.exists()){
          await updateDoc(classRef,{members:arrayUnion(currentUser.uid),name:snap.data()?.name||trimmed});
          showToast('Joined existing class ‚úì','success');
        }else{
          await setDoc(classRef,{name:trimmed,createdAt:serverTimestamp(),ownerUid:currentUser.uid,members:[currentUser.uid],students:[]});
          showToast('Class created ‚úì','success');
        }
        setCurrentClass(id);
      }catch(err){
        console.error(err);
        showToast('Unable to create class','error');
      }
    }

    async function handleJoinClass(){
      if(!currentUser){showToast('Sign in to join a class.','error');return;}
      const code=prompt('Enter the class code to join');
      if(code===null)return;
      const trimmed=code.trim();
      if(!trimmed){showToast('Class code is required.','error');return;}
      let classId=trimmed;
      let classRef=doc(db,'classes',classId);
      let snap=await getDoc(classRef);
      if(!snap.exists()){
        const normalized=slug(trimmed);
        if(normalized){
          classId=normalized;
          classRef=doc(db,'classes',classId);
          snap=await getDoc(classRef);
        }
      }
      if(!snap.exists()){
        showToast('Class not found.','error');
        return;
      }
      try{
        await updateDoc(classRef,{members:arrayUnion(currentUser.uid)});
        showToast('Joined class ‚úì','success');
        setCurrentClass(classId);
      }catch(err){
        console.error(err);
        showToast('Unable to join class.','error');
      }
    }

    async function handleAddStudent(){
      if(!currentClassId){showToast('Select a class first.','error');return;}
      const name=prompt('Student name');
      if(name===null)return;
      const trimmed=name.trim();
      if(!trimmed){showToast('Student name is required.','error');return;}
      if(classStudents.some(s=>s.toLowerCase()===trimmed.toLowerCase())){
        showToast('Student already exists.','error');
        return;
      }
      const classRef=doc(db,'classes',currentClassId);
      try{
        pendingStudentSelection=trimmed;
        await updateDoc(classRef,{students:arrayUnion(trimmed)});
        showToast('Student added ‚úì','success');
      }catch(err){
        console.error(err);
        showToast('Unable to add student.','error');
      }
    }

    async function maybeLoadTodaysEntry(student){
      if(!student)return;
      const notesRef=getClassNotesCollection();
      if(!notesRef)return;
      const expectedClassId=currentClassId;
      const selectionToken=student;
      const today=toLocalISODate(new Date());
      const id=noteId(today,student);
      try{
        const snap=await getDoc(doc(notesRef,id));
        if(currentClassId!==expectedClassId)return;
        if(inputs.student.value!==selectionToken)return;
        if(snap.exists()){
          setEditMode({...snap.data(),id:snap.id});
        }else{
          const legacy=legacyNotesCache.find(r=>r.id===id);
          if(legacy){
            setEditMode({id:legacy.id,...legacy});
          }else if(editingKey){
            setEditMode(null,{preserveStudent:true});
          }
        }
      }catch(err){
        console.error('Failed to load daily entry',err);
      }
    }

    historyBody.addEventListener('click',async(e)=>{

      const btn=e.target.closest('button'); if(!btn) return;
      const notesRef=getClassNotesCollection();
      if(!notesRef)return;
      const id=btn.getAttribute('data-id');
      if(btn.getAttribute('data-action')==='edit'){
        const snap=await getDoc(doc(notesRef,id));
        if(snap.exists()) setEditMode({id:snap.id,...snap.data()});
      } else if(btn.getAttribute('data-action')==='delete'){
        if(!confirm('Delete this note?')) return;
        await deleteDoc(doc(notesRef,id));
        showToast('Deleted','success');

      }
    });

    // Auth gate
    onAuthStateChanged(auth,(user)=>{
      currentUser=user||null;
      if(user){
        authGate.classList.add('hidden');
        appShell.classList.remove('hidden');
        whoami.textContent=user.email||user.uid;
        authStatus.textContent='Online';
        dot.className='w-2 h-2 rounded-full bg-emerald-400';
        updateClassStatus('Loading classes‚Ä¶');
        watchUserClasses(user.uid);
      } else {
        if(classesUnsub){classesUnsub();classesUnsub=null;}
        resetAppState();
        renderClassSelect(null);
        appShell.classList.add('hidden');
        authGate.classList.remove('hidden');
        whoami.textContent='Not signed in';
        authStatus.textContent='Signed out';
        dot.className='w-2 h-2 rounded-full bg-amber-400';
      }
    });

    // Utils
    function extractDateFromId(id){if(!id)return null;const m=String(id).match(/^(\d{4}-\d{2}-\d{2})_/);return m?m[1]:null;}
    function parseDate(input){
      if(!input&&input!==0)return null;
      if(input instanceof Date)return isNaN(input.getTime())?null:input;
      if(typeof input?.toDate==='function'){const d=input.toDate();return d instanceof Date&&!isNaN(d.getTime())?d:null;}
      const str=String(input).trim();
      const iso=str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(iso){const[,y,m,d]=iso;const dt=new Date(Number(y),Number(m)-1,Number(d));return isNaN(dt.getTime())?null:dt;}
      const slash=str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if(slash){const[,d,m,y]=slash;const dt=new Date(Number(y),Number(m)-1,Number(d));return isNaN(dt.getTime())?null:dt;}
      const parsed=new Date(str);return isNaN(parsed.getTime())?null:parsed;
    }
    function toLocalISODate(value){
      const date=value instanceof Date?value:parseDate(value);
      if(!date)return '';
      const year=date.getFullYear();
      const month=String(date.getMonth()+1).padStart(2,'0');
      const day=String(date.getDate()).padStart(2,'0');
      return `${year}-${month}-${day}`;
    }
    function formatDisplayDate(value){
      const date=value instanceof Date?value:parseDate(value);
      if(!date)return value??'';
      const day=date.getDate();
      const month=MONTH_LABELS[date.getMonth()]||'';
      const year=date.getFullYear();
      return month?`${day} ${month} ${year}`:value??'';
    }
    function formatMonthYear(monthValue){
      if(!monthValue)return '';
      const parts=String(monthValue).split('-');
      if(parts.length<2)return monthValue;
      const year=Number(parts[0]); const monthIndex=Number(parts[1])-1;
      if(Number.isNaN(year)||Number.isNaN(monthIndex)||monthIndex<0||monthIndex>11)return monthValue;
      const month=MONTH_LABELS[monthIndex]||''; return month?`${month} ${year}`:monthValue;
    }
    function getMonthDateRange(monthValue){
      if(!monthValue)return null;
      const parts=String(monthValue).split('-'); if(parts.length<2)return null;
      const yearStr=parts[0]; const monthNum=Number(parts[1]); const monthIndex=monthNum-1; const year=Number(yearStr);
      if(Number.isNaN(year)||Number.isNaN(monthIndex)||monthIndex<0||monthIndex>11)return null;
      const monthStr=String(monthIndex+1).padStart(2,'0');
      const lastDay=new Date(year,monthIndex+1,0).getDate();
      const endDay=String(lastDay).padStart(2,'0');
      return {start:`${yearStr}-${monthStr}-01`,end:`${yearStr}-${monthStr}-${endDay}`};
    }
    function isInMonth(dateValue,monthValue){
      const date=parseDate(dateValue); if(!date||!monthValue)return false;
      const [yearStr,monthStr]=String(monthValue).split('-');
      const year=Number(yearStr); const month=Number(monthStr);
      if(Number.isNaN(year)||Number.isNaN(month))return false;
      return date.getFullYear()===year&&date.getMonth()+1===month;
    }
    function toCsvValue(value){const str=(value??'').toString().replace(/"/g,'""').replace(/\r?\n/g,' ');return `"${str}"`;}
    function esc(s){return (s??'').toString().replace(/[&<>\"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]))}
    function showToast(text,type='success'){ toast.textContent=text; toast.className=`notification show ${type}`; setTimeout(()=>{toast.classList.remove('show')},1600); }
  </script>
</body>
</html>
